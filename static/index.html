<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta charset="utf-8">
    <title>Robot control</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <script src="/js/jquery-2.0.3.min.js"></script>
    <script src="/js/jquery.knob.js"></script>
    <script src="/js/socket.io.js"></script>
</head>

<body id="home">

<div class="container">
    <div class="row">
        <div class="col-md-6 col-lg-6 col-sm-12" style="padding: 50px;"></div>
        </div>
    <div class="row">
        <div class="col-md-6 col-lg-6 col-sm-12">
            <div class="row">
                <div class="col-xs-12" style="text-align: center">
                    <a id="forward" href="#" class="btn btn-lg btn-danger">
                        <span class="glyphicon glyphicon-circle-arrow-up"></span>
                        Forward
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <a id="left" href="#" class="btn btn-lg btn-info">
                        <span class="glyphicon glyphicon-circle-arrow-left"></span>
                        Left
                    </a>
                </div>

                <div class="col-xs-6">
                    <a id="right" href="#" class="btn btn-lg btn-info pull-right">
                        <span class="glyphicon glyphicon-circle-arrow-right"></span>
                        Right
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12" style="text-align: center">
                    <a id="back" href="#" class="btn btn-lg btn-danger">
                        <span class="glyphicon glyphicon-circle-arrow-down"></span>
                        Back !
                    </a>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-lg-6">
            <input id="speed" type="text" value="0" class="dial" style="margin-top: 50px;">
        </div>
    </div>


</div>

<script>
    var socket = io.connect('ws://10.0.0.1:8000');
    var speedKnob = $("#speed");
    speedKnob.knob({
        min : 0,
        max : 6,
        'skin':"tron",
        'change' : function (value) {
            console.log(value);
        }
    });
    var btnFwd = $("#forward"),
        btnBack = $("#back"),
        btnLeft = $("#left"),
        btnRight = $("#right");

    var timeoutId = 0;

    function allEngineSend() {
        socket.emit('all_engine', { val : speedKnob.val()});
    }
    function revAllEngineSend() {
        socket.emit('rev_all_engine', { val : speedKnob.val()});
    }
    function rightEngineSend() {
        socket.emit('rengine', { val : speedKnob.val()});
    }
    function leftEngineSend() {
        socket.emit('lengine', { val : speedKnob.val()});
    }
    function registerTimeout(motorCommand) {
        clearTimeout(timeoutId);

        timeoutId = setTimeout(function() {
            motorCommand();
            timeoutId = registerTimeout(motorCommand);
        }, 400);
        return timeoutId;
    }
    function registerEndXEvent(btn) {
        btn.on("touchend touchmove touchleave touchcancel mouseup", function(ev) {
            ev.preventDefault();
            clearTimeout(timeoutId);
        });
    }

    function registerStartXEvent(btn, motorAction) {
        btn.on("touchstart mousedown", function(ev) {
            ev.preventDefault();

            motorAction();
            registerTimeout(function() {
                motorAction();
            })
        });
    }

    registerStartXEvent(btnFwd, function() { allEngineSend() });
    registerStartXEvent(btnLeft, function() { leftEngineSend() });
    registerStartXEvent(btnRight, function() { rightEngineSend() });
    registerStartXEvent(btnBack, function() { revAllEngineSend() });

    registerEndXEvent(btnFwd);
    registerEndXEvent(btnLeft);
    registerEndXEvent(btnRight);
    registerEndXEvent(btnBack);

</script>

</body>
</html>
